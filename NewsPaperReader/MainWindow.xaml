<Window x:Class="NewsPaperReader.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:NewsPaperReader"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        mc:Ignorable="d"
        Title="心仪读报"
        Height="800" Width="1200"
        MinHeight="600" MinWidth="900"
        WindowStartupLocation="CenterScreen"
        Loaded="MainWindow_Loaded">

    <Window.Resources>
        <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <local:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <local:DownloadStatusToColorConverter x:Key="DownloadStatusToColorConverter"/>
        <local:DownloadStatusToVisibilityConverter x:Key="DownloadStatusToVisibilityConverter"/>
        <local:BoolToStringConverter x:Key="BoolToStringConverter"/>
        <local:BoolToPinIconConverter x:Key="BoolToPinIconConverter"/>
        
        <!-- 滚动条按钮样式 -->
        <Style x:Key="ScrollBarButtonStyle" TargetType="RepeatButton">
            <Setter Property="Visibility" Value="Collapsed"/>
        </Style>
    </Window.Resources>

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="40"
                      GlassFrameThickness="0"
                      CornerRadius="0"
                      ResizeBorderThickness="5"/>
    </WindowChrome.WindowChrome>

    <Border BorderThickness="1" BorderBrush="{DynamicResource MaterialDesignDivider}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 标题栏 -->
            <Border Grid.Row="0" Height="40" Background="{DynamicResource MaterialDesignPaper}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- 应用图标和标题 -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="12,0">
                        <materialDesign:PackIcon Kind="NewspaperVariant" 
                                               Width="20" Height="20"
                                               VerticalAlignment="Center"/>
                        <TextBlock Text="EERSOFT-心仪读报 v0.5.0" 
                                  FontSize="14" FontWeight="Medium"
                                  Margin="8,0,0,0"
                                  VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- 窗口控制按钮 -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" WindowChrome.IsHitTestVisibleInChrome="True">
                        <Button Style="{StaticResource ToolbarButtonStyle}" ToolTip="最小化" Click="MinimizeButton_Click">
                            <materialDesign:PackIcon Kind="WindowMinimize" Width="16" Height="16"/>
                        </Button>
                        <Button x:Name="MaximizeButton" Style="{StaticResource ToolbarButtonStyle}" ToolTip="最大化" Click="MaximizeButton_Click">
                            <materialDesign:PackIcon x:Name="MaximizeIcon" Kind="WindowMaximize" Width="16" Height="16"/>
                        </Button>
                        <Button Style="{StaticResource CloseButtonStyle}" ToolTip="关闭" Click="CloseButton_Click"/>

                    </StackPanel>
                </Grid>
            </Border>

            <!-- 主内容区域 -->
            <Grid Grid.Row="1" Margin="0,0,5,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>



                <!-- 左侧边栏 -->
                <Border Grid.Column="0"
                        Background="{DynamicResource MaterialDesignPaper}"
                        BorderThickness="0,0,1,0"
                        BorderBrush="{DynamicResource MaterialDesignDivider}"
                        Width="{Binding SidebarWidth}"
                        Visibility="{Binding IsSidebarVisible, Converter={StaticResource BoolToVisibilityConverter}}"
                        MouseEnter="Sidebar_MouseEnter"
                        MouseLeave="Sidebar_MouseLeave">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="4*"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="6*"/>
                        </Grid.RowDefinitions>

                        <!-- 工具栏 -->
                        <Border Grid.Row="0" Background="{DynamicResource MaterialDesignPaper}" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource MaterialDesignDivider}">
                            <StackPanel Orientation="Horizontal">
                                <Button Command="{Binding AddNewspaperCommand}" Margin="2" Style="{StaticResource ToolbarButtonStyle}" ToolTip="添加报纸">
                                    <materialDesign:PackIcon Kind="Plus"/>
                                </Button>
                                <Button Command="{Binding RefreshCommand}" Margin="2" Style="{StaticResource ToolbarButtonStyle}" ToolTip="刷新">
                                    <materialDesign:PackIcon Kind="Refresh"/>
                                </Button>
                                <Button Command="{Binding SettingsCommand}" Margin="2" Style="{StaticResource ToolbarButtonStyle}" ToolTip="设置">
                                    <materialDesign:PackIcon Kind="Cog"/>
                                </Button>
                                <Button Command="{Binding ToggleSidebarPinCommand}" Margin="2" Style="{StaticResource ToolbarButtonStyle}" ToolTip="{Binding IsSidebarPinned, Converter={StaticResource BoolToStringConverter}}">
                                    <materialDesign:PackIcon Kind="{Binding IsSidebarPinned, Converter={StaticResource BoolToPinIconConverter}}"/>
                                </Button>
                            </StackPanel>
                        </Border>

                        <!-- 报纸列表 -->
                        <Grid Grid.Row="1">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0" Background="{DynamicResource MaterialDesignCardBackground}" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource MaterialDesignDivider}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="报纸列表" 
                                              FontSize="14" FontWeight="Bold"
                                              Margin="12,8"
                                              Foreground="{DynamicResource MaterialDesignBody}" Opacity="0.6"/>
                                    <Grid Grid.Column="1" Margin="0,8,12,8">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <materialDesign:PackIcon Grid.Column="0" Kind="Magnify" Margin="0,0,0,0" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                        <TextBox Grid.Column="1" materialDesign:TextFieldAssist.HasClearButton="True"
                                                 Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                                                 materialDesign:HintAssist.Hint="搜索报纸..." Margin="4,0,0,0"/>
                                    </Grid>
                                </Grid>
                            </Border>

                            <ListBox x:Name="NewspaperListBox" Grid.Row="1"
                                    ItemsSource="{Binding FilteredNewspapers}"
                                    SelectedItem="{Binding SelectedNewspaper}"
                                    BorderThickness="0"
                                    ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem">
                                        <Setter Property="Padding" Value="2,2"/>
                                        <Setter Property="Cursor" Value="Hand"/>
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                
                                <ListBox.Resources>
                                    <!-- 自定义滚动条样式，使其变窄 -->
                                    <Style TargetType="ScrollBar">
                                        <Setter Property="Width" Value="6"/>
                                        <Setter Property="MinWidth" Value="6"/>
                                        <Setter Property="Template">
                                            <Setter.Value>
                                                <ControlTemplate TargetType="ScrollBar">
                                                    <Grid Background="{DynamicResource MaterialDesignDivider}">
                                                        <Track Name="PART_Track" Orientation="Vertical" IsDirectionReversed="True">
                                                            <Track.DecreaseRepeatButton>
                                                                <RepeatButton Command="ScrollBar.PageUpCommand" Style="{StaticResource ScrollBarButtonStyle}"/>
                                                            </Track.DecreaseRepeatButton>
                                                            <Track.Thumb>
                                                                <Thumb BorderThickness="0">
                                                                    <Thumb.Template>
                                                                        <ControlTemplate TargetType="Thumb">
                                                                            <Border Background="{DynamicResource MaterialDesignBody}" BorderThickness="0" CornerRadius="3"/>
                                                                        </ControlTemplate>
                                                                    </Thumb.Template>
                                                                </Thumb>
                                                            </Track.Thumb>
                                                            <Track.IncreaseRepeatButton>
                                                                <RepeatButton Command="ScrollBar.PageDownCommand" Style="{StaticResource ScrollBarButtonStyle}"/>
                                                            </Track.IncreaseRepeatButton>
                                                        </Track>
                                                    </Grid>
                                                </ControlTemplate>
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                    
                                    <!-- 文本列表模板 -->
                                    <DataTemplate x:Key="TextListTemplate">
                                        <Grid Margin="0,4">
                                            <TextBlock Text="{Binding Name}"
                                                      FontSize="14" FontWeight="Medium"
                                                      TextTrimming="CharacterEllipsis"/>
                                        </Grid>
                                    </DataTemplate>



                                    <!-- 图片平铺模板 -->
                                    <DataTemplate x:Key="ImageTileTemplate">
                                        <Border Width="100" 
                                               CornerRadius="6"
                                               Background="{DynamicResource MaterialDesignPaper}"
                                               Margin="2"
                                               Cursor="Hand">
                                            <Grid Height="40">
                                                <Image Source="{Binding TitleImagePath}"
                                                      Stretch="Uniform"
                                                      Visibility="{Binding TitleImagePath, Converter={StaticResource NullToVisibilityConverter}}"/>
                                                <TextBlock Text="{Binding Name}"
                                                           TextWrapping="Wrap"
                                                           TextAlignment="Center"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"
                                                           Padding="4"
                                                           Visibility="{Binding TitleImagePath, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.Resources>

                                <ListBox.ItemTemplateSelector>
                                    <local:NewspaperTemplateSelector 
                                        TextListTemplate="{StaticResource TextListTemplate}"
                                        ImageTileTemplate="{StaticResource ImageTileTemplate}"/>
                                </ListBox.ItemTemplateSelector>

                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal" ItemWidth="104" ItemHeight="120"/>
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                            </ListBox>
                        </Grid>

                        <!-- 版面列表标题 -->
                        <Border Grid.Row="2" Background="{DynamicResource MaterialDesignCardBackground}" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource MaterialDesignDivider}">
                            <TextBlock Text="版面列表" 
                                      FontSize="14" FontWeight="Bold"
                                      Margin="12,8"
                                      Foreground="{DynamicResource MaterialDesignBody}" Opacity="0.6"/>
                        </Border>

                        <!-- 版面列表 -->
                        <ListBox Grid.Row="3"
                                ItemsSource="{Binding SelectedNewspaper.Editions}"
                                SelectedItem="{Binding SelectedEdition}"
                                BorderThickness="0">
                            <ListBox.Resources>
                                <!-- 自定义滚动条样式，使其变窄 -->
                                <Style TargetType="ScrollBar">
                                    <Setter Property="Width" Value="6"/>
                                    <Setter Property="MinWidth" Value="6"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="ScrollBar">
                                                <Grid Background="{DynamicResource MaterialDesignDivider}">
                                                    <Track Name="PART_Track" Orientation="Vertical" IsDirectionReversed="True">
                                                        <Track.DecreaseRepeatButton>
                                                            <RepeatButton Command="ScrollBar.PageUpCommand" Style="{StaticResource ScrollBarButtonStyle}"/>
                                                        </Track.DecreaseRepeatButton>
                                                        <Track.Thumb>
                                                            <Thumb BorderThickness="0">
                                                                <Thumb.Template>
                                                                    <ControlTemplate TargetType="Thumb">
                                                                        <Border Background="{DynamicResource MaterialDesignBody}" BorderThickness="0" CornerRadius="3"/>
                                                                    </ControlTemplate>
                                                                </Thumb.Template>
                                                            </Thumb>
                                                        </Track.Thumb>
                                                        <Track.IncreaseRepeatButton>
                                                            <RepeatButton Command="ScrollBar.PageDownCommand" Style="{StaticResource ScrollBarButtonStyle}"/>
                                                        </Track.IncreaseRepeatButton>
                                                    </Track>
                                                </Grid>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </ListBox.Resources>
                            <ListBox.ItemContainerStyle>
                                <Style TargetType="ListBoxItem">
                                    <Setter Property="Padding" Value="12,8"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                </Style>
                            </ListBox.ItemContainerStyle>
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,4">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0"
                                               Width="24" Height="24"
                                               CornerRadius="12"
                                               Background="{Binding DownloadStatus, Converter={StaticResource DownloadStatusToColorConverter}}"
                                               Margin="0,0,8,0">
                                            <materialDesign:PackIcon Kind="FileDocument"
                                                                   Width="14" Height="14"
                                                                   Foreground="White"
                                                                   HorizontalAlignment="Center"
                                                                   VerticalAlignment="Center"/>
                                        </Border>
                                        
                                        <TextBlock Grid.Column="1"
                                                  Text="{Binding Title}"
                                                  VerticalAlignment="Center"/>
                                        
                                        <Button Grid.Column="2"
                                               Style="{StaticResource ToolbarButtonStyle}"
                                               Width="28" Height="28"
                                               Command="{Binding DataContext.DownloadEditionCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                               CommandParameter="{Binding}"
                                               ToolTip="下载"
                                               Visibility="{Binding DownloadStatus, Converter={StaticResource DownloadStatusToVisibilityConverter}}">
                                            <materialDesign:PackIcon Kind="Download" Width="14" Height="14"/>
                                        </Button>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>

                <!-- 右侧内容区 -->
                <Grid Grid.Column="1">
                    <!-- WebView2内容区 -->
                    <wv2:WebView2 x:Name="WebView2PdfViewer"
                                 Source="{Binding CurrentContent}"
                                 DefaultBackgroundColor="White"/>
                </Grid>
            </Grid>

            <!-- 状态栏 -->
            <Border x:Name="StatusBar" Grid.Row="2" Height="30" Background="{DynamicResource MaterialDesignPaper}" BorderThickness="0,1,0,0" BorderBrush="{DynamicResource MaterialDesignDivider}" Visibility="{Binding IsStatusBarVisible, Converter={StaticResource BoolToVisibilityConverter}}">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0"
                              Text="{Binding StatusText}"
                              FontSize="12"
                              VerticalAlignment="Center"
                              Margin="12,0"/>

                    <ProgressBar Grid.Column="1"
                                Width="100"
                                Height="10"
                                Margin="0,10,12,10"
                                Visibility="Collapsed"/>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
